<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulating dose-escalation trials • escalation</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulating dose-escalation trials">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">escalation</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/A100-DoseSelectors.html">Using escalation</a></li>
    <li><a class="dropdown-item" href="../articles/A205-CRM.html">CRM - Continual Reassessment Method</a></li>
    <li><a class="dropdown-item" href="../articles/A207-NBG.html">NBG - Neuenschwander, Branson &amp; Gsponer</a></li>
    <li><a class="dropdown-item" href="../articles/A210-TPI.html">TPI - Toxicity Probability Interval Design</a></li>
    <li><a class="dropdown-item" href="../articles/A220-mTPI.html">mTPI - Modified Toxicity Probability Interval Design</a></li>
    <li><a class="dropdown-item" href="../articles/A230-BOIN.html">BOIN - Bayesian Optimal Interval Design</a></li>
    <li><a class="dropdown-item" href="../articles/A280-TITE.html">TITE-CRM and TITE-NBG - Time-to-Event Designs</a></li>
    <li><a class="dropdown-item" href="../articles/A310-EfficacyToxicity.html">EffTox, Wages &amp; Tait, and BOIN12 - Efficacy &amp; Toxicity Designs</a></li>
    <li><a class="dropdown-item" href="../articles/A360-Combinations.html">BOIN-COMB - Treatment Combination Designs</a></li>
    <li><a class="dropdown-item" href="../articles/A600-DosePaths.html">Working with dose-paths</a></li>
    <li><a class="dropdown-item" href="../articles/A700-Simulation.html">Simulating dose-escalation trials</a></li>
    <li><a class="dropdown-item" href="../articles/A710-SimulationComparison.html">Comparing dose-escalation designs by simulation</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/brockk/escalation/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Simulating dose-escalation trials</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/brockk/escalation/blob/master/vignettes/A700-Simulation.Rmd" class="external-link"><code>vignettes/A700-Simulation.Rmd</code></a></small>
      <div class="d-none name"><code>A700-Simulation.Rmd</code></div>
    </div>

    
    
<p>The <code>escalation</code> package by Kristian Brock. Documentation
is hosted at <a href="https://brockk.github.io/escalation/" class="external-link uri">https://brockk.github.io/escalation/</a></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Before reading this document on simulating dose-finding trials using
the <code>escalation</code> package, be sure to check out the <a href="https://brockk.github.io/escalation/" class="external-link">README file</a>. It explains
how to compose dose-finding designs using the flexible syntax provided
in <code>escalation</code>.</p>
<p>Once you have composed a design that appeals, you will want to learn
about its operating performance by running many simulated trials, and
possibly compare it to competing designs. That is the focus of this
vignette. We study simulations because we believe they will predict the
performance we can expect in reality. By operating performance, we
mean:</p>
<ul>
<li>how often a design recommends a desirable dose;</li>
<li>how many patients are treated;</li>
<li>how many patients are treated at desirable doses;</li>
<li>how many toxicities are seen;</li>
<li>how often the design recommends stopping;</li>
<li>how long trials take;</li>
<li>and so on.</li>
</ul>
<p>We are often interested both in the absolute levels of these
quantities, and how they compare to those of competing designs. When
comparing designs, we have an efficient method called
<code>simulate_compare</code> that examines the decisions of many design
on the same simulated patients to reduce Monte Carlo uncertainty.</p>
</div>
<div class="section level2">
<h2 id="simulating-trials-in-escalation">Simulating trials in <code>escalation</code><a class="anchor" aria-label="anchor" href="#simulating-trials-in-escalation"></a>
</h2>
<p>Simulations are run using the <code>simulate_trials</code> and
<code>simulate_compare</code> functions. These functions can be called
for any dose-escalation design in <code>escalation</code>. Specifying
dose-escalation models is the focus of the package <a href="https://brockk.github.io/escalation/" class="external-link">README file</a>.</p>
<p><code>simulate_trials</code> runs simulations for a single particular
design. This is the focus of this vignette. In contrast,
<code>simulate_compare</code> compares several competing designs using
efficient methods that share notional patients across designs, ensuring
efficient comparisons. This topic is the focus of the <a href="A710-SimulationComparison.html">Simulation Comparison
vignette</a>.</p>
<div class="section level3">
<h3 id="the-simplest-example">The simplest example<a class="anchor" aria-label="anchor" href="#the-simplest-example"></a>
</h3>
<p>Let us start with a very simple example by simulating performance of
the 3+3 design in trial of five doses. We need to specify the unknown
true probabilities of toxicity at the doses under investigation. Let us
investigate:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">true_prob_tox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.12</span>, <span class="fl">0.27</span>, <span class="fl">0.44</span>, <span class="fl">0.53</span>, <span class="fl">0.57</span><span class="op">)</span></span></code></pre></div>
<p>That is, doses 1 and 2 are what most clinicians would describe as
tolerable, but doses 3, 4, and 5 are reasonably toxic. The 3+3 design
does not target a particular probability of toxicity but empirically,
the design tends to target doses with associated toxicity rates of
10-25%<span class="citation">(Korn et al. 1994; Iasonos et al.
2008)</span>.</p>
<p>We must load the <code>escalate</code> package:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://brockk.github.io/escalation/" class="external-link">escalation</a></span><span class="op">)</span></span></code></pre></div>
<p>For the purposes of illustration, let us simulate a modest number of
trials:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_sims</span> <span class="op">&lt;-</span> <span class="fl">20</span></span></code></pre></div>
<p>In reality, if we want to have confidence in the simulated results,
we would tend to run thousands of iterations <span class="citation">(Wheeler et al. 2019)</span>. We run a small number
here so that this vignette compiles quickly.</p>
<p>We run simulations in our scenario using:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_three_plus_three.html">get_three_plus_three</a></span><span class="op">(</span>num_doses <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/simulate_trials.html">simulate_trials</a></span><span class="op">(</span>num_sims <span class="op">=</span> <span class="va">num_sims</span>, true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span><span class="op">)</span></span></code></pre></div>
<p>We set the random number generator seed in the example above so that
results are (hopefully) reproducible. Despite setting the seed, the
results could still vary across different operating systems or versions
of R.</p>
<p>When printed to the screen, the <code>sims</code> object shows some
useful summary information:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sims</span></span>
<span><span class="co">#&gt; Number of iterations: 20 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of doses: 5 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; True probability of toxicity:</span></span>
<span><span class="co">#&gt;    1    2    3    4    5 </span></span>
<span><span class="co">#&gt; 0.12 0.27 0.44 0.53 0.57 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Probability of recommendation:</span></span>
<span><span class="co">#&gt; NoDose      1      2      3      4      5 </span></span>
<span><span class="co">#&gt;   0.10   0.70   0.15   0.05   0.00   0.00 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Probability of administration:</span></span>
<span><span class="co">#&gt;      1      2      3      4      5 </span></span>
<span><span class="co">#&gt; 0.3934 0.5082 0.0656 0.0328 0.0000 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample size:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;    3.00    8.25    9.00    9.15    9.75   18.00 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Total toxicities:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;    2.00    2.00    2.00    2.35    3.00    4.00 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Trial duration:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;   1.570   6.453   8.997   8.391  10.418  16.713</span></span></code></pre></div>
<p>Each of those pieces of information is available progmatically by R
functions. For instance, the probability of recommending each dose at
the final analysis, inferred from these simulated iterations, is:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prob_recommend.html">prob_recommend</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span></span>
<span><span class="co">#&gt; NoDose      1      2      3      4      5 </span></span>
<span><span class="co">#&gt;   0.10   0.70   0.15   0.05   0.00   0.00</span></span></code></pre></div>
<p>Bear in mind that these probabilities are the result of a random
process. If we run the simulations again with a different seed, we will
get different results. Recall also that they are informed by a small
number of simulated replicates so there will be considerable uncertainty
around these statistics. If we ran a greater number of replicates, there
would be less uncertainty.</p>
<p>We infer from the probabilities above that the design is likely to
recommend one of the first two doses. However, there is a non-trivial
probability that the design will recommend the third dose, which is
probably too toxic, or recommend no dose at all.</p>
<p>How many patients are required?</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/num_patients.html">num_patients</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;    3.00    8.25    9.00    9.15    9.75   18.00</span></span></code></pre></div>
<p>We see that the simulated trials use between 3 and 24 patients, with
an expected number of 9-12.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/n_at_recommended_dose.html">n_at_recommended_dose</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's </span></span>
<span><span class="co">#&gt;     3.0     3.0     3.0     3.5     3.0     6.0       2</span></span></code></pre></div>
<p>Of those, 3-4 at treated at the dose that is eventually
recommended.</p>
<p>We can see how many patients are treated at each dose on a
trial-by-trial basis. Here are the allocation counts for the first 10
trials:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/n_at_dose.html">n_at_dose</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 5</span></span></span>
<span><span class="co">#&gt;      `1`   `2`   `3`   `4`   `5`</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     3     6     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     6     3     3     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3     6     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     3     6     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     6     6     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     3     6     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     6     6     3     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     3     6     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     3     3     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     3     3     3     0     0</span></span></code></pre></div>
<p>This information is aggregated in the probabilities of administation,
i.e. the probability that an individual patient is treated at each
dose-level:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prob_administer.html">prob_administer</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span></span>
<span><span class="co">#&gt;          1          2          3          4          5 </span></span>
<span><span class="co">#&gt; 0.39344262 0.50819672 0.06557377 0.03278689 0.00000000</span></span></code></pre></div>
<p>We might be alarmed to learn that roughly 25% of patients are treated
at doses 3-5, the doses we believe to be excessively toxic.</p>
<p>We can also see how many toxicities there were at each dose in the
simulated trials (again, here are just the first 10):</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tox_at_dose.html">tox_at_dose</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 5</span></span></span>
<span><span class="co">#&gt;      `1`   `2`   `3`   `4`   `5`</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     0     2     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1     0     2     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     0     2     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     0     2     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1     2     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     0     3     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1     1     2     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     0     2     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     0     2     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     0     0     2     0     0</span></span></code></pre></div>
<p>and a summary of the total number of toxicities seen in the
replicates:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/num_tox.html">num_tox</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;    2.00    2.00    2.00    2.35    3.00    4.00</span></span></code></pre></div>
<p>We expect to see about 2-3 toxicities using this design in this
scenario with no iteration producing more than 6 toxicities.</p>
<p>For convenience, simulations can be cast to a
<code>tibble</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 12</span></span></span>
<span><span class="co">#&gt;    .iteration .depth  time dose     tox     n empiric_tox_rate mean_prob_tox</span></span>
<span><span class="co">#&gt;         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;ord&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>          1      4  6.47 NoDose     0     0            0                 0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>          1      4  6.47 1          0     3            0                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>          1      4  6.47 2          2     6            0.333            <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>          1      4  6.47 3          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>          1      4  6.47 4          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>          1      4  6.47 5          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>          2      5 12.6  NoDose     0     0            0                 0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>          2      5 12.6  1          1     6            0.167            <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>          2      5 12.6  2          0     3            0                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>          2      5 12.6  3          2     3            0.667            <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span>          2      5 12.6  4          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span>          2      5 12.6  5          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4 more variables: median_prob_tox &lt;dbl&gt;, admissible &lt;lgl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   recommended &lt;lgl&gt;, true_prob_tox &lt;dbl&gt;</span></span></span></code></pre></div>
<p>This returns a <code>tidyverse</code> <code>tibble</code>,
essentially a fancy data-frame, with the followign columns:</p>
<ul>
<li>
<code>.iteration</code>, the number of the simulated trial
iteration, i.e. <code>.iteration == 1</code> is the first simulated
trial, etc;</li>
<li>
<code>.depth</code>, the cohort number. In the example above we see
that the first trial ended after the second cohort but the second trial
went as far as cohort 9;</li>
<li>
<code>time</code>, the time of the analysis, essentially the sum of
all of the intra-patient recruitment times;</li>
<li>
<code>dose</code>, the numerical dose-level or ‘NoDose’ for the
option to select no dose;</li>
<li>
<code>tox</code>, the number of toxicity events seen;</li>
<li>
<code>n</code>, the number of patients evaluated;</li>
<li>
<code>empiric_tox_rate</code>, simply <code>tox</code> divided by
<code>n</code>;</li>
<li>
<code>mean_prob_tox</code>, if the method supports statistical
estimation, the modelled mean toxicity probability;</li>
<li>
<code>median_prob_tox</code>, if the method supports statistical
estimation, the modelled median toxicity probability;</li>
<li>
<code>recommended</code>, a logical to show whethet this dose (or
stopping) was recommended by this iteration;</li>
<li>
<code>true_prob_tox</code>, the true yet unknown probability of
toxicity in this simulated scenario.</li>
</ul>
<p>Other selection models might add more columns to this object.</p>
<p>Getting the results in <code>tibble</code> format is liberating for
analysis and visualisation. For instance, using further
<code>tidyverse</code> packages, it is simple to visualise the
frequencies of the final model recommendations:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">recommended</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dose</span>, fill <span class="op">=</span> <span class="va">dose</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="A700-Simulation_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="a-more-complex-example">A more complex example<a class="anchor" aria-label="anchor" href="#a-more-complex-example"></a>
</h3>
<p>Let us consider now a model-based dose-finding approach in the same
scenario. We will investigate a CRM design, using the model from the
<code>dfcrm</code> package. Let us say that we are targeting a 25%
toxicity rate:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fl">0.25</span></span></code></pre></div>
<p>and that our prior beliefs on the toxicity rates can be represented
by:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">skeleton</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span><span class="op">)</span></span></code></pre></div>
<p>i.e. we believe the third dose is the dose we seek.</p>
<p>The CRM design as provided by <code>dfcrm</code> offers no native
stopping behaviour. Let us say we are willing to use up to 12 patients.
How does performance of this simple design compare to the 3+3 above?</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_dfcrm.html">get_dfcrm</a></span><span class="op">(</span>skeleton <span class="op">=</span> <span class="va">skeleton</span>, target <span class="op">=</span> <span class="va">target</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/stop_at_n.html">stop_at_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/simulate_trials.html">simulate_trials</a></span><span class="op">(</span>num_sims <span class="op">=</span> <span class="va">num_sims</span>, true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sims</span></span>
<span><span class="co">#&gt; Number of iterations: 20 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of doses: 5 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; True probability of toxicity:</span></span>
<span><span class="co">#&gt;    1    2    3    4    5 </span></span>
<span><span class="co">#&gt; 0.12 0.27 0.44 0.53 0.57 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Probability of recommendation:</span></span>
<span><span class="co">#&gt; NoDose      1      2      3      4      5 </span></span>
<span><span class="co">#&gt;   0.00   0.20   0.35   0.40   0.05   0.00 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Probability of administration:</span></span>
<span><span class="co">#&gt;     1     2     3     4     5 </span></span>
<span><span class="co">#&gt; 0.375 0.225 0.125 0.225 0.050 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample size:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;      12      12      12      12      12      12 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Total toxicities:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;    1.00    3.00    4.00    3.65    4.25    6.00 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Trial duration:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;   7.204  10.197  12.149  11.756  13.025  17.429</span></span></code></pre></div>
<p>The first thing we note is that the CRM design is much less likely to
select dose 1 and more likely to select dose 2. If we believe that
efficacy is associated with toxicity (and we should if we are using the
CRM approach), then this is a good thing. Note, however, that comparing
separate simulations is not the most efficient method to compare
competing designs. A preferable method is to use
<code>simulate_compare</code>, demonstrated below.</p>
<p>However, our design has no method to stop if all doses are too toxic.
We saw above that the 3+3 design occasionally recommended no dose. Thus,
when comparing this CRM design to the 3+3, we are not comparing like
with like. It is simple to add a stopping behaviour for excess
toxicity:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_dfcrm.html">get_dfcrm</a></span><span class="op">(</span>skeleton <span class="op">=</span> <span class="va">skeleton</span>, target <span class="op">=</span> <span class="va">target</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/stop_at_n.html">stop_at_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/stop_when_too_toxic.html">stop_when_too_toxic</a></span><span class="op">(</span>dose <span class="op">=</span> <span class="fl">1</span>, tox_threshold <span class="op">=</span> <span class="fl">0.35</span>, confidence <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/simulate_trials.html">simulate_trials</a></span><span class="op">(</span>num_sims <span class="op">=</span> <span class="va">num_sims</span>, true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sims</span></span>
<span><span class="co">#&gt; Number of iterations: 20 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of doses: 5 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; True probability of toxicity:</span></span>
<span><span class="co">#&gt;    1    2    3    4    5 </span></span>
<span><span class="co">#&gt; 0.12 0.27 0.44 0.53 0.57 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Probability of recommendation:</span></span>
<span><span class="co">#&gt; NoDose      1      2      3      4      5 </span></span>
<span><span class="co">#&gt;   0.00   0.25   0.45   0.20   0.10   0.00 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Probability of administration:</span></span>
<span><span class="co">#&gt;      1      2      3      4      5 </span></span>
<span><span class="co">#&gt; 0.5250 0.1875 0.0875 0.1875 0.0125 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample size:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;      12      12      12      12      12      12 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Total toxicities:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;     2.0     3.0     3.0     3.2     4.0     5.0 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Trial duration:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;   5.347   9.121  10.778  10.824  12.453  16.080</span></span></code></pre></div>
<p>We now see some trial iterations that stop and recommend <em>no
dose</em> for further study. We cannot see from this scenario whether
this design stops frequently enough because an appropriate decision in
this scenario is to select one of the lowest two doses. We will research
a scenario where all doses are too toxic below.</p>
<p>Given the fixed sample size, how many are treated at the dose that is
eventually recommended</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/n_at_recommended_dose.html">n_at_recommended_dose</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;     0.0     3.0     3.0     4.8     6.0    12.0</span></span></code></pre></div>
<p>Similar to the 3+3 design, this CRM design treats 3-4 at the
recommended dose. We might want to ensure that there are at least 6
patients at the recommended dose. How would that affect the operating
characteristics?</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_dfcrm.html">get_dfcrm</a></span><span class="op">(</span>skeleton <span class="op">=</span> <span class="va">skeleton</span>, target <span class="op">=</span> <span class="va">target</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/stop_at_n.html">stop_at_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/stop_when_too_toxic.html">stop_when_too_toxic</a></span><span class="op">(</span>dose <span class="op">=</span> <span class="fl">1</span>, tox_threshold <span class="op">=</span> <span class="fl">0.35</span>, confidence <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/demand_n_at_dose.html">demand_n_at_dose</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">6</span>, dose <span class="op">=</span> <span class="st">'recommended'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/simulate_trials.html">simulate_trials</a></span><span class="op">(</span>num_sims <span class="op">=</span> <span class="va">num_sims</span>, true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span><span class="op">)</span></span></code></pre></div>
<p>As required, there are now at least 6 patients at the recommended
dose:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/n_at_recommended_dose.html">n_at_recommended_dose</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's </span></span>
<span><span class="co">#&gt;   6.000   6.000   6.000   6.789   6.000  12.000       1</span></span></code></pre></div>
<p>So how does this affect the expected overall sample size?</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sims</span></span>
<span><span class="co">#&gt; Number of iterations: 20 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of doses: 5 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; True probability of toxicity:</span></span>
<span><span class="co">#&gt;    1    2    3    4    5 </span></span>
<span><span class="co">#&gt; 0.12 0.27 0.44 0.53 0.57 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Probability of recommendation:</span></span>
<span><span class="co">#&gt; NoDose      1      2      3      4      5 </span></span>
<span><span class="co">#&gt;   0.05   0.30   0.45   0.20   0.00   0.00 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Probability of administration:</span></span>
<span><span class="co">#&gt;      1      2      3      4      5 </span></span>
<span><span class="co">#&gt; 0.4490 0.2857 0.1327 0.1224 0.0102 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample size:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;     3.0    12.0    15.0    14.7    18.0    21.0 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Total toxicities:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;    2.00    3.00    3.50    4.15    5.00    9.00 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Trial duration:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;   5.534  13.641  16.064  16.436  19.347  28.336</span></span></code></pre></div>
<p>Pleasingly, the expected sample size only increases by about 3
patients. Obviously, the maximum increases by 6 patients.</p>
</div>
<div class="section level3">
<h3 id="further-refinements">Further refinements<a class="anchor" aria-label="anchor" href="#further-refinements"></a>
</h3>
<p>The following behaviours apply to both <code>simulate_trials</code>
and <code>simulate_compare</code>.</p>
<div class="section level4">
<h4 id="cohort-size">Cohort size<a class="anchor" aria-label="anchor" href="#cohort-size"></a>
</h4>
<p>All of the above simulations assume that patients are evaluated in
cohorts of three. That assumption is made mainly by convention but
naturally it is possible to change that.</p>
<p>We can adjust in simulations the way that simulated patients arrive
by providing a custom function via the
<code>sample_patient_arrivals</code> parameter. For instance, if we want
the model to recommend a new dose after every other patient, we can
specify that the <code>sample_patient_arrivals</code> function samples
patients in cohorts of two:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">patient_arrivals_func</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">current_data</span><span class="op">)</span> <span class="fu"><a href="../reference/cohorts_of_n.html">cohorts_of_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_dfcrm.html">get_dfcrm</a></span><span class="op">(</span>skeleton <span class="op">=</span> <span class="va">skeleton</span>, target <span class="op">=</span> <span class="va">target</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/stop_at_n.html">stop_at_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/stop_when_too_toxic.html">stop_when_too_toxic</a></span><span class="op">(</span>dose <span class="op">=</span> <span class="fl">1</span>, tox_threshold <span class="op">=</span> <span class="fl">0.35</span>, confidence <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/demand_n_at_dose.html">demand_n_at_dose</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">6</span>, dose <span class="op">=</span> <span class="st">'recommended'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/simulate_trials.html">simulate_trials</a></span><span class="op">(</span>num_sims <span class="op">=</span> <span class="va">num_sims</span>, true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span>,</span>
<span>                  sample_patient_arrivals <span class="op">=</span> <span class="va">patient_arrivals_func</span><span class="op">)</span></span></code></pre></div>
<p>The <code>sample_patient_arrivals</code> function samples the arrival
times of new patients for the next interim analysis. The new patients
will be added to the existing patients and the model will be fit to the
set of all patients. The function that simulates patient arrivals should
take as a single parameter a data-frame with one row for each existing
patient and columns including <code>cohort</code>, <code>patient</code>,
<code>dose</code>, <code>tox</code>, <code>time</code> (and possibly
also <code>eff</code> and <code>weight</code>, if a phase I/II or
time-to-event method is used). The provision of data on the existing
patients to <code>sample_patient_arrivals</code> allows the patient
sampling function to be adaptive. The function should return a
data-frame with a row for each new patient and a column for
<code>time_delta</code>, the time between the arrival of this patient
and the previous, like the <code>cohorts_of_n</code> function does:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cohorts_of_n.html">cohorts_of_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;   time_delta</span></span>
<span><span class="co">#&gt; 1 0.99586980</span></span>
<span><span class="co">#&gt; 2 0.02669685</span></span>
<span><span class="co">#&gt; 3 0.67005583</span></span>
<span><span class="co">#&gt; 4 2.52444885</span></span>
<span><span class="co">#&gt; 5 1.88378957</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="sampling-the-conclusion-of-partly-observed-trials">Sampling the conclusion of partly-observed trials<a class="anchor" aria-label="anchor" href="#sampling-the-conclusion-of-partly-observed-trials"></a>
</h4>
<p>The examples demonstrated so far simulate whole trials, from the
recruitment and evaluation of the first patient to the last. However,
<code>simulate_trials</code> will gladly simulate the culmination of
trials that are partly completed. We just have to specify the outcomes
already observed via the <code>previous_outcomes</code> parameter. Each
simulated trial will commence from those outcomes seen thus far.</p>
<p>For example, let us say that we have observed the first cohort of
three already at dose 1, yielding one toxicities and two
non-toxicities.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/simulate_trials.html">simulate_trials</a></span><span class="op">(</span>num_sims <span class="op">=</span> <span class="va">num_sims</span>, true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span>,</span>
<span>                  previous_outcomes <span class="op">=</span> <span class="st">'1NTN'</span><span class="op">)</span></span></code></pre></div>
<p>The appearance of an early toxicity at dose 1 appear to make it more
likely that a low dose will be recommended, as we might expect:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prob_recommend.html">prob_recommend</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span></span>
<span><span class="co">#&gt; NoDose      1      2      3      4      5 </span></span>
<span><span class="co">#&gt;    0.0    0.4    0.6    0.0    0.0    0.0</span></span></code></pre></div>
<p>The <code>previous_outcomes</code> can be described by the outcome
string method demonstrated above. They can also be provided via a
data-frame, with the following columns:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">previous_outcomes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  patient <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,</span>
<span>  cohort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  tox <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  dose <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/simulate_trials.html">simulate_trials</a></span><span class="op">(</span>num_sims <span class="op">=</span> <span class="va">num_sims</span>, true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span>,</span>
<span>                  previous_outcomes <span class="op">=</span> <span class="va">previous_outcomes</span><span class="op">)</span></span></code></pre></div>
<p>We have just described the trial starting point in two different
ways. The simulated iterations should produce exactly the same
results:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prob_recommend.html">prob_recommend</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span></span>
<span><span class="co">#&gt; NoDose      1      2      3      4      5 </span></span>
<span><span class="co">#&gt;    0.0    0.4    0.6    0.0    0.0    0.0</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="next-dose">Next dose<a class="anchor" aria-label="anchor" href="#next-dose"></a>
</h4>
<p>Likewise, we can also set the dose to be given to the next patient or
cohort of patients by specifying the <code>next_dose</code> parameter.
For example, if we want to commence our simulations at dose 5, we would
run:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/simulate_trials.html">simulate_trials</a></span><span class="op">(</span>num_sims <span class="op">=</span> <span class="va">num_trials</span>, true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span>,</span>
<span>                  next_dose <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>If omitted, the next dose is calculated by invoking the model on the
prevailing outcomes, a set that may well be empty. In this setting, most
models would opt to start at dose 1 but this may vary by method.</p>
</div>
<div class="section level4">
<h4 id="all-model-fits">All model fits<a class="anchor" aria-label="anchor" href="#all-model-fits"></a>
</h4>
<p>In simulations, the dose selection model is fit to the prevailing
data at each interim analysis. By default, only the final model fit for
each simulated trial is returned. This is done to conserve memory. With
a high number of simulated trials, storing many model fits per trial may
cause the executing machine to run out of memory. However, you can force
this function to retain all model fits by specifying
<code>return_all_fits = TRUE</code>.</p>
<p>For example:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_three_plus_three.html">get_three_plus_three</a></span><span class="op">(</span>num_doses <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/simulate_trials.html">simulate_trials</a></span><span class="op">(</span>num_sims <span class="op">=</span> <span class="va">num_sims</span>, true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span>,</span>
<span>                  return_all_fits <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We can verify that there are now many analyses per trial:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">sims</span><span class="op">$</span><span class="va">fits</span>, <span class="va">length</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 3 3 4 3 4 6 4 4 7 3 5 6 5 6 3 5 6 4 4 5</span></span></code></pre></div>
<p>The multiple fits within a single simulated trial are distinguishable
in <code>tibble</code> view via the <code>.depth</code> column:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 12</span></span></span>
<span><span class="co">#&gt;    .iteration .depth  time dose     tox     n empiric_tox_rate mean_prob_tox</span></span>
<span><span class="co">#&gt;         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;ord&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>          1      1  0    NoDose     0     0            0                 0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>          1      1  0    1          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>          1      1  0    2          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>          1      1  0    3          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>          1      1  0    4          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>          1      1  0    5          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>          1      2  2.48 NoDose     0     0            0                 0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>          1      2  2.48 1          1     3            0.333            <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>          1      2  2.48 2          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>          1      2  2.48 3          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span>          1      2  2.48 4          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span>          1      2  2.48 5          0     0          <span style="color: #BB0000;">NaN</span>                <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4 more variables: median_prob_tox &lt;dbl&gt;, admissible &lt;lgl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   recommended &lt;lgl&gt;, true_prob_tox &lt;dbl&gt;</span></span></span></code></pre></div>
<p>In contrast to the previous usage of <code>as_tibble(sims)</code>, we
see that there are now model fits at multiple fits within each simulated
trial <code>.iteration</code>. The rows at <code>.depth == 1</code>
reflect the initial model fit before any new patients are recruited,
essentially the starting point of this simulated trial. The rows at
<code>.depth == 2</code> show the model fit after the first cohort of
patients, and so on.</p>
</div>
<div class="section level4">
<h4 id="big-trials">Big trials<a class="anchor" aria-label="anchor" href="#big-trials"></a>
</h4>
<p>Designs must eventually choose to stop the trial. However, some
selectors, like those derived from <code>get_dfcrm</code>, offer no
default stopping method. You may need to append stopping behaviour to
your selector via something like <code>stop_at_n</code> or
<code>stop_when_n_at_dose</code>, etc. To safeguard against simulating
runaway trials that never end, the <code>simulate_trials</code> function
will halt a simulated trial after 30 invocations of the dose-selection
decision. To breach this limit, specify
<code>i_like_big_trials = TRUE</code> in the function call. However,
when you forego the safety net, the onus is on you to write selectors
that will eventually stop the trial, so be careful!</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_dfcrm.html">get_dfcrm</a></span><span class="op">(</span>skeleton <span class="op">=</span> <span class="va">skeleton</span>, target <span class="op">=</span> <span class="va">target</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/stop_at_n.html">stop_at_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">99</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/simulate_trials.html">simulate_trials</a></span><span class="op">(</span>num_sims <span class="op">=</span> <span class="fl">1</span>, true_prob_tox <span class="op">=</span> <span class="va">true_prob_tox</span>,</span>
<span>                  i_like_big_trials <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/num_patients.html">num_patients</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 99</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Iasonos2008" class="csl-entry">
Iasonos, Alexia, Andrew S Wilton, Elyn R Riedel, Venkatraman E Seshan,
and David R Spriggs. 2008. <span>“A Comprehensive Comparison of the
Continual Reassessment Method to the Standard 3 + 3 Dose Escalation
Scheme in <span>Phase</span> <span>I</span> Dose-Finding
Studies.”</span> <em>Clinical Trials (London, England)</em> 5 (5):
465–77. <a href="https://doi.org/10.1177/1740774508096474" class="external-link">https://doi.org/10.1177/1740774508096474</a>.
</div>
<div id="ref-korn1994" class="csl-entry">
Korn, Edward L., Douglas Midthune, T. Timothy Chen, Lawrence V.
Rubinstein, Michaele C. Christian, and Richard M. Simon. 1994. <span>“A
Comparison of Two Phase <span>I</span> Trial Designs.”</span>
<em>Statistics in Medicine</em> 13 (18): 1799–1806. <a href="https://doi.org/10.1002/sim.4780131802" class="external-link">https://doi.org/10.1002/sim.4780131802</a>.
</div>
<div id="ref-wheelerHowDesignDosefinding2019" class="csl-entry">
Wheeler, Graham M., Adrian P. Mander, Alun Bedding, Kristian Brock,
Victoria Cornelius, Andrew P. Grieve, Thomas Jaki, et al. 2019.
<span>“How to Design a Dose-Finding Study Using the Continual
Reassessment Method.”</span> <em>BMC Medical Research Methodology</em>
19 (1). <a href="https://doi.org/10.1186/s12874-018-0638-z" class="external-link">https://doi.org/10.1186/s12874-018-0638-z</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kristian Brock, Daniel Slade, Michael Sweeting.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
